<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POC EAM ‚Äî SAP ¬∑ Suivi d'actions</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><text y='28' font-size='28'>üìã</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:linear-gradient(160deg,#0b0e18 0%,#10141f 40%,#0d1117 100%);font-family:'Outfit',-apple-system,sans-serif;color:#e2e8f0;min-height:100vh;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}
input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(0.7)}
@keyframes syncPulse{0%,100%{opacity:1}50%{opacity:0.4}}
@keyframes alertPulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4)}70%{box-shadow:0 0 0 8px rgba(239,68,68,0)}}
.sync-indicator{display:inline-flex;align-items:center;gap:5px;font-size:10px;padding:3px 8px;border-radius:5px}
.sync-online{background:rgba(16,185,129,0.15);color:#34d399}
.sync-offline{background:rgba(239,68,68,0.15);color:#f87171}
.sync-dot{width:6px;height:6px;border-radius:50%;animation:syncPulse 2s ease-in-out infinite}
.filter-group{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);border-radius:10px;padding:10px 14px}
.filter-label{font-size:9px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:#525d6e;margin-bottom:8px;display:block}
.alert-card{animation:alertPulse 2s infinite}
</style>
</head>
<body>
<div id="root"></div>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBljsA_mTCb6ngYZ8iIlUzJOmTWymjJae0",
  authDomain: "suivi-poc-eam.firebaseapp.com",
  databaseURL: "https://suivi-poc-eam-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "suivi-poc-eam",
  storageBucket: "suivi-poc-eam.firebasestorage.app",
  messagingSenderId: "981660175686",
  appId: "1:981660175686:web:e49ed29d97b535fb1de947"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const actionsRef = db.ref('actions');
</script>
<script type="text/babel">
const{useState,useEffect,useCallback}=React;

const INIT=[
  {id:"a1",action:"Confirmer le dispositif SAP",detail:"Point focal, staffing, modalit√©s de contact ¬´ value prototyping ¬ª. Donner de la visibilit√© sur l'organisation et les interlocuteurs.",responsables:["SAP (Thomas)"],dateDebut:"2025-02-03",dateFin:"2025-02-07",priorite:"haute",statut:"en_cours",categorie:"SAP"},
  {id:"a2",action:"Partager un RETEX client comparable",detail:"Recherche d'entreprises similaires (taille/industrie) pour cr√©dibiliser la d√©marche aupr√®s du m√©tier.",responsables:["SAP (Thomas)"],dateDebut:"2025-02-03",dateFin:"2025-02-10",priorite:"haute",statut:"en_cours",categorie:"SAP"},
  {id:"a3",action:"Consolider les cas d'usage / user stories par module",detail:"Compiler les initiatives, formaliser des histoires ¬´ bout en bout ¬ª.",responsables:["Ga√´tan"],dateDebut:"2025-02-10",dateFin:"2025-02-14",priorite:"haute",statut:"en_cours",categorie:"Pilote"},
  {id:"a4",action:"D√©finir les crit√®res de succ√®s du POC (GO / NO GO)",detail:"√âviter d√©rive de p√©rim√®tre et subjectivit√© en fin de POC.",responsables:["Arnaud","David"],dateDebut:"2025-02-10",dateFin:"2025-02-12",priorite:"haute",statut:"en_cours",categorie:"Architecte"},
  {id:"a5",action:"Caler les cr√©neaux d√©mos + ateliers",detail:"Anticiper la disponibilit√© des populations (planif vs PPM).",responsables:["Ga√´tan"],dateDebut:"2025-02-03",dateFin:"2025-02-06",priorite:"critique",statut:"en_cours",categorie:"Pilote"},
  {id:"a6",action:"Clarifier le param√©trage BTP et activation g√©ospatiale",detail:"Pr√©parer les gestes techniques non encore r√©alis√©s (pr√©-requis).",responsables:["Ga√´l"],dateDebut:"2025-02-10",dateFin:"2025-02-21",priorite:"haute",statut:"en_cours",categorie:"Architecte"},
  {id:"a7",action:"Clarifier la mobilisation Sopra Steria",detail:"R√¥le, modalit√©s, contractualisation. Point sensible : besoin potentiel de consultants pour configuration/adaptation.",responsables:["SAP (Thomas)"],dateDebut:"2025-02-03",dateFin:"2025-02-10",priorite:"moyenne",statut:"en_cours",categorie:"SAP"},
  {id:"a8",action:"Pr√©parer liste de features par module",detail:"Support pour aligner process m√©tier vs capacit√©s solution.",responsables:["Arnaud","David"],dateDebut:"2025-02-10",dateFin:"2025-02-14",priorite:"moyenne",statut:"en_cours",categorie:"Architecte"},
  {id:"a9",action:"D√©finir les collectifs Planification et Programmation",detail:"Constituer ces collectifs avec les EO, Archi, AF et le PM.",responsables:[],dateDebut:"2025-02-10",dateFin:"2025-02-14",priorite:"haute",statut:"fait",categorie:"Pilote"},
  {id:"a10",action:"Communiquer la priorisation des sc√©narios EAM",detail:"Clarifier que les phases d'instruction seront men√©es en priorit√© sur les sc√©narios EAM.",responsables:["Cam√©lia"],dateDebut:"2025-02-03",dateFin:"2025-02-07",priorite:"haute",statut:"fait",categorie:"Pilote"},
  {id:"a11",action:"Prendre contact avec SAP pour acc√®s modules & d√©mos POC",detail:"Pr√©parer FSM et EPPM, organiser des d√©monstrations en vue des POC.",responsables:["Ga√´l S≈ìur"],dateDebut:"2025-02-03",dateFin:"2025-02-07",priorite:"critique",statut:"fait",categorie:"SAP"},
  {id:"a12",action:"S√©curiser les achats en gr√© √† gr√© avec SAP",detail:"√âviter le lancement d'un RFP. Valider la proc√©dure d'achat.",responsables:["Nicolas Cossard"],dateDebut:"2025-02-03",dateFin:"2025-02-10",priorite:"moyenne",statut:"a_faire",categorie:"Pilote"},
  {id:"a13",action:"Prendre contact avec Oxya (int√©grateur potentiel)",detail:"Explorer le partenariat d'int√©gration pour la solution SAP.",responsables:["Ga√´l","Ga√´tan"],dateDebut:"2025-02-10",dateFin:"2025-02-14",priorite:"haute",statut:"en_cours",categorie:"Pilote"},
  {id:"a14",action:"Communication √† l'ensemble de la cha√Æne de valeur GAI",detail:"Planifier un point 1h apr√®s les ateliers.",responsables:[],dateDebut:"2026-02-05",dateFin:"2026-02-12",priorite:"moyenne",statut:"a_faire",categorie:"Architecte"},
  {id:"a15",action:"Mettre en place une gouvernance DSI / EO",detail:"",responsables:["Ga√´tan"],dateDebut:"2026-02-05",dateFin:"2026-02-12",priorite:"moyenne",statut:"a_faire",categorie:"Pilote"},
  {id:"a16",action:"Organisation de la formation - Prise en main du POC",detail:"",responsables:[],dateDebut:"2026-02-05",dateFin:"2026-02-12",priorite:"moyenne",statut:"a_faire",categorie:"Pilote"},
  {id:"a17",action:"Suivi du point achat",detail:"",responsables:[],dateDebut:"2026-02-05",dateFin:"2026-02-12",priorite:"moyenne",statut:"a_faire",categorie:"Pilote"},
];

const STATUTS={
  a_faire:{label:"√Ä faire",color:"#64748b",bg:"rgba(100,116,139,0.15)"},
  en_cours:{label:"En cours",color:"#60a5fa",bg:"rgba(96,165,250,0.12)"},
  fait:{label:"Fait",color:"#10b981",bg:"rgba(16,185,129,0.15)"},
  bloque:{label:"Bloqu√©",color:"#ef4444",bg:"rgba(239,68,68,0.15)"},
};
const PRIOS={
  critique:{label:"Critique",color:"#ef4444",icon:"üî¥"},
  haute:{label:"Haute",color:"#f59e0b",icon:"üü†"},
  moyenne:{label:"Moyenne",color:"#3b82f6",icon:"üîµ"},
};
const CATS=["Architecte","Data","EO","PM","SAP","Pilote"];
const CAT_COLORS={Architecte:"#a78bfa",Data:"#34d399",EO:"#fbbf24",PM:"#f472b6",SAP:"#60a5fa",Pilote:"#fb923c"};
const gid=()=>"a"+Date.now()+Math.random().toString(36).slice(2,6);

const normalizeAction=(a)=>({...a,responsables:Array.isArray(a.responsables)?a.responsables:[]});
const saveToFirebase=(actions)=>{actionsRef.set(actions);};
const initFirebase=(callback)=>{
  actionsRef.once('value').then((snapshot)=>{if(!snapshot.exists())actionsRef.set(INIT);});
  actionsRef.on('value',(snapshot)=>{
    const data=snapshot.val();
    if(data){
      const arr=Array.isArray(data)?data:Object.values(data);
      callback(arr.map(normalizeAction));
    }
  });
};

// Helpers
const today=new Date();today.setHours(0,0,0,0);
const isLate=(a)=>a.statut!=="fait"&&new Date(a.dateFin)<today;
const daysLate=(a)=>Math.ceil((today-new Date(a.dateFin))/(1000*60*60*24));
const isThisWeek=(a)=>{const d=new Date(a.dateFin);const diff=(d-today)/(1000*60*60*24);return diff>=0&&diff<=7&&a.statut!=="fait";};

/* UI Components */
function Modal({open,onClose,title,children}){
  if(!open)return null;
  return(<div style={{position:"fixed",inset:0,zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center"}} onClick={onClose}>
    <div style={{position:"absolute",inset:0,background:"rgba(0,0,0,0.6)",backdropFilter:"blur(4px)"}}/>
    <div onClick={e=>e.stopPropagation()} style={{position:"relative",width:"92%",maxWidth:"580px",maxHeight:"90vh",overflow:"auto",background:"#151a28",border:"1px solid rgba(255,255,255,0.07)",borderRadius:"16px",padding:"28px",boxShadow:"0 25px 60px rgba(0,0,0,0.5)"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"}}>
        <h3 style={{margin:0,fontSize:"17px",fontWeight:600,color:"#e2e8f0"}}>{title}</h3>
        <button onClick={onClose} style={{background:"rgba(255,255,255,0.06)",border:"none",color:"#94a3b8",width:"30px",height:"30px",borderRadius:"8px",cursor:"pointer",fontSize:"15px"}}>‚úï</button>
      </div>{children}
    </div></div>);
}
function FL({children}){return <label style={{display:"block",fontSize:"10px",fontWeight:600,letterSpacing:"1.5px",textTransform:"uppercase",color:"#818cf8",marginBottom:"5px"}}>{children}</label>;}
function Inp({value,onChange,placeholder,type="text",style:s={},onKeyDown}){return <input type={type} value={value||""} onChange={onChange} placeholder={placeholder} onKeyDown={onKeyDown} style={{width:"100%",padding:"9px 13px",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:"9px",color:"#e2e8f0",fontSize:"13px",outline:"none",boxSizing:"border-box",...s}}/>;}
function Sel({value,onChange,children,style:s={}}){return <select value={value||""} onChange={onChange} style={{width:"100%",padding:"9px 13px",background:"#151a28",border:"1px solid rgba(255,255,255,0.08)",borderRadius:"9px",color:"#e2e8f0",fontSize:"13px",outline:"none",boxSizing:"border-box",...s}}>{children}</select>;}
function Btn({onClick,children,variant="primary",style:s={}}){
  const V={primary:{background:"rgba(129,140,248,0.15)",border:"1px solid rgba(129,140,248,0.3)",color:"#c7d2fe"},danger:{background:"rgba(239,68,68,0.12)",border:"1px solid rgba(239,68,68,0.25)",color:"#fca5a5"},ghost:{background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.07)",color:"#94a3b8"},success:{background:"rgba(16,185,129,0.12)",border:"1px solid rgba(16,185,129,0.3)",color:"#6ee7b7"}};
  return <button onClick={onClick} style={{padding:"8px 16px",borderRadius:"9px",fontSize:"12px",fontWeight:600,cursor:"pointer",transition:"all 0.2s",...V[variant],...s}}>{children}</button>;
}
function SyncStatus({online}){return(<div className={`sync-indicator ${online?'sync-online':'sync-offline'}`}><div className="sync-dot" style={{background:online?'#34d399':'#f87171'}}/>{online?'Synchro':'Hors ligne'}</div>);}
function RespChips({list}){
  const items=Array.isArray(list)?list:[];
  if(!items.length)return <span style={{fontSize:"11px",color:"#475569",fontStyle:"italic"}}>Non assign√©</span>;
  return(<div style={{display:"flex",flexWrap:"wrap",gap:"4px"}}>
    {items.map((r,i)=><span key={i} style={{fontSize:"11px",fontWeight:600,padding:"3px 9px",borderRadius:"6px",background:"rgba(255,255,255,0.08)",color:"#e2e8f0",border:"1px solid rgba(255,255,255,0.06)"}}>{r}</span>)}
  </div>);
}

/* Donut Chart */
function DonutChart({data,size=160}){
  const total=data.reduce((s,d)=>s+d.value,0);
  if(total===0)return<div style={{width:size,height:size,display:"flex",alignItems:"center",justifyContent:"center",color:"#475569"}}>Aucune donn√©e</div>;
  let acc=0;
  const segments=data.filter(d=>d.value>0).map(d=>{const start=acc;acc+=(d.value/total)*360;return{...d,start,end:acc};});
  const r=size/2-10;const cx=size/2;const cy=size/2;
  const polarToCart=(angle,radius)=>({x:cx+radius*Math.cos((angle-90)*Math.PI/180),y:cy+radius*Math.sin((angle-90)*Math.PI/180)});
  return(<svg width={size} height={size} style={{display:"block"}}>
    {segments.map((seg,i)=>{
      const s=polarToCart(seg.start,r);const e=polarToCart(seg.end,r);const large=seg.end-seg.start>180?1:0;
      return<path key={i} d={`M${cx},${cy} L${s.x},${s.y} A${r},${r} 0 ${large} 1 ${e.x},${e.y} Z`} fill={seg.color} style={{opacity:0.85}}/>;
    })}
    <circle cx={cx} cy={cy} r={r*0.6} fill="#10141f"/>
    <text x={cx} y={cy-5} textAnchor="middle" fill="#e2e8f0" fontSize="22" fontWeight="700">{total}</text>
    <text x={cx} y={cy+12} textAnchor="middle" fill="#64748b" fontSize="10">actions</text>
  </svg>);
}

/* Bar Chart */
function BarChart({data,height=180}){
  const max=Math.max(...data.map(d=>d.value),1);
  return(<div style={{display:"flex",alignItems:"flex-end",gap:"8px",height,padding:"10px 0"}}>
    {data.map((d,i)=>(<div key={i} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:"6px"}}>
      <span style={{fontSize:"12px",fontWeight:700,color:d.color}}>{d.value}</span>
      <div style={{width:"100%",maxWidth:"40px",height:`${(d.value/max)*100}%`,minHeight:"4px",background:d.color,borderRadius:"4px 4px 0 0",opacity:0.8,transition:"height 0.5s ease"}}/>
      <span style={{fontSize:"9px",color:"#64748b",textAlign:"center",lineHeight:1.2}}>{d.label}</span>
    </div>))}
  </div>);
}

/* Progress Ring */
function ProgressRing({percent,size=100,color="#818cf8"}){
  const r=size/2-8;const circ=2*Math.PI*r;const offset=circ-(percent/100)*circ;
  return(<svg width={size} height={size} style={{transform:"rotate(-90deg)"}}>
    <circle cx={size/2} cy={size/2} r={r} fill="none" stroke="rgba(255,255,255,0.05)" strokeWidth="8"/>
    <circle cx={size/2} cy={size/2} r={r} fill="none" stroke={color} strokeWidth="8" strokeLinecap="round" strokeDasharray={circ} strokeDashoffset={offset} style={{transition:"stroke-dashoffset 0.8s ease"}}/>
    <text x={size/2} y={size/2} textAnchor="middle" dominantBaseline="middle" fill="#e2e8f0" fontSize="18" fontWeight="700" style={{transform:"rotate(90deg)",transformOrigin:"center"}}>{percent}%</text>
  </svg>);
}

/* Dashboard View */
function DashboardView({actions,onEdit,onStatusChange}){
  const stats={
    total:actions.length,
    fait:actions.filter(a=>a.statut==="fait").length,
    en_cours:actions.filter(a=>a.statut==="en_cours").length,
    a_faire:actions.filter(a=>a.statut==="a_faire").length,
    bloque:actions.filter(a=>a.statut==="bloque").length,
    critique:actions.filter(a=>a.priorite==="critique"&&a.statut!=="fait").length,
    late:actions.filter(isLate).length,
    thisWeek:actions.filter(isThisWeek).length,
  };
  const pct=stats.total>0?Math.round((stats.fait/stats.total)*100):0;
  const lateActions=actions.filter(isLate).sort((a,b)=>new Date(a.dateFin)-new Date(b.dateFin));
  const weekActions=actions.filter(isThisWeek).sort((a,b)=>new Date(a.dateFin)-new Date(b.dateFin));
  
  const statutData=[
    {label:"√Ä faire",value:stats.a_faire,color:"#64748b"},
    {label:"En cours",value:stats.en_cours,color:"#60a5fa"},
    {label:"Fait",value:stats.fait,color:"#10b981"},
    {label:"Bloqu√©",value:stats.bloque,color:"#ef4444"},
  ];
  const catData=CATS.map(c=>({label:c,value:actions.filter(a=>a.categorie===c).length,color:CAT_COLORS[c]}));
  const prioData=[
    {label:"Critique",value:actions.filter(a=>a.priorite==="critique"&&a.statut!=="fait").length,color:"#ef4444"},
    {label:"Haute",value:actions.filter(a=>a.priorite==="haute"&&a.statut!=="fait").length,color:"#f59e0b"},
    {label:"Moyenne",value:actions.filter(a=>a.priorite==="moyenne"&&a.statut!=="fait").length,color:"#3b82f6"},
  ];

  return(<div style={{display:"flex",flexDirection:"column",gap:"20px"}}>
    {/* KPIs Row */}
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:"10px"}}>
      {[
        {l:"Total",v:stats.total,c:"#818cf8",icon:"üìä"},
        {l:"Termin√©es",v:stats.fait,c:"#10b981",icon:"‚úÖ"},
        {l:"En cours",v:stats.en_cours,c:"#60a5fa",icon:"üîÑ"},
        {l:"√Ä faire",v:stats.a_faire,c:"#64748b",icon:"üìù"},
        {l:"Bloqu√©es",v:stats.bloque,c:"#ef4444",icon:"üö´"},
        {l:"En retard",v:stats.late,c:stats.late>0?"#ef4444":"#64748b",icon:"‚ö†Ô∏è"},
      ].map((s,i)=>(
        <div key={i} style={{background:s.v>0&&s.l==="En retard"?"rgba(239,68,68,0.08)":"rgba(255,255,255,0.02)",border:`1px solid ${s.v>0&&s.l==="En retard"?"rgba(239,68,68,0.2)":"rgba(255,255,255,0.04)"}`,borderRadius:"12px",padding:"16px"}}>
          <div style={{display:"flex",alignItems:"center",gap:"8px",marginBottom:"8px"}}>
            <span style={{fontSize:"16px"}}>{s.icon}</span>
            <span style={{fontSize:"10px",textTransform:"uppercase",letterSpacing:"1px",color:"#64748b",fontWeight:500}}>{s.l}</span>
          </div>
          <div style={{fontSize:"28px",fontWeight:700,color:s.c}}>{s.v}</div>
        </div>
      ))}
    </div>

    {/* Charts Row */}
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(280px,1fr))",gap:"16px"}}>
      {/* Progress + Donut */}
      <div style={{background:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.04)",borderRadius:"14px",padding:"20px"}}>
        <h3 style={{fontSize:"13px",fontWeight:600,color:"#94a3b8",marginBottom:"16px",letterSpacing:"0.5px"}}>üìà PROGRESSION GLOBALE</h3>
        <div style={{display:"flex",alignItems:"center",justifyContent:"space-around",gap:"20px"}}>
          <ProgressRing percent={pct} size={110} color="#10b981"/>
          <div style={{display:"flex",flexDirection:"column",gap:"8px"}}>
            {statutData.map((s,i)=>(<div key={i} style={{display:"flex",alignItems:"center",gap:"8px"}}>
              <div style={{width:"10px",height:"10px",borderRadius:"3px",background:s.color}}/>
              <span style={{fontSize:"11px",color:"#94a3b8",minWidth:"60px"}}>{s.label}</span>
              <span style={{fontSize:"12px",fontWeight:600,color:s.color}}>{s.value}</span>
            </div>))}
          </div>
        </div>
      </div>

      {/* Par cat√©gorie */}
      <div style={{background:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.04)",borderRadius:"14px",padding:"20px"}}>
        <h3 style={{fontSize:"13px",fontWeight:600,color:"#94a3b8",marginBottom:"16px",letterSpacing:"0.5px"}}>üìÅ PAR CAT√âGORIE</h3>
        <BarChart data={catData} height={140}/>
      </div>

      {/* Par priorit√© */}
      <div style={{background:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.04)",borderRadius:"14px",padding:"20px"}}>
        <h3 style={{fontSize:"13px",fontWeight:600,color:"#94a3b8",marginBottom:"16px",letterSpacing:"0.5px"}}>üéØ PAR PRIORIT√â (ouvertes)</h3>
        <BarChart data={prioData} height={140}/>
      </div>
    </div>

    {/* Alerts Section */}
    {lateActions.length>0&&(
      <div style={{background:"rgba(239,68,68,0.05)",border:"1px solid rgba(239,68,68,0.15)",borderRadius:"14px",padding:"20px"}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"16px"}}>
          <h3 style={{fontSize:"14px",fontWeight:700,color:"#fca5a5",display:"flex",alignItems:"center",gap:"8px"}}>
            <span style={{fontSize:"18px"}}>üö®</span> ACTIONS EN RETARD ({lateActions.length})
          </h3>
        </div>
        <div style={{display:"flex",flexDirection:"column",gap:"8px"}}>
          {lateActions.map(a=>{
            const days=daysLate(a);const pr=PRIOS[a.priorite];const st=STATUTS[a.statut];
            return(<div key={a.id} className="alert-card" style={{background:"rgba(0,0,0,0.2)",border:"1px solid rgba(239,68,68,0.2)",borderRadius:"10px",padding:"12px 16px",display:"flex",alignItems:"center",gap:"12px"}}>
              <div style={{width:"40px",height:"40px",borderRadius:"10px",background:"rgba(239,68,68,0.15)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
                <span style={{fontSize:"14px",fontWeight:700,color:"#ef4444"}}>-{days}j</span>
              </div>
              <div style={{flex:1,minWidth:0}}>
                <div style={{fontSize:"12px",fontWeight:600,color:"#e2e8f0",marginBottom:"4px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{a.action}</div>
                <div style={{display:"flex",alignItems:"center",gap:"8px",flexWrap:"wrap"}}>
                  <span style={{fontSize:"9px",fontWeight:600,padding:"2px 6px",borderRadius:"4px",background:st.bg,color:st.color}}>{st.label}</span>
                  <span style={{fontSize:"9px",color:pr.color,fontWeight:600}}>{pr.icon} {pr.label}</span>
                  <RespChips list={a.responsables}/>
                </div>
              </div>
              <div style={{display:"flex",gap:"6px",flexShrink:0}}>
                <Btn variant="ghost" onClick={()=>onEdit(a)} style={{padding:"6px 10px",fontSize:"10px"}}>‚úé</Btn>
                <Btn variant="success" onClick={()=>onStatusChange(a.id,"en_cours")} style={{padding:"6px 10px",fontSize:"10px"}}>‚ñ∂ Relancer</Btn>
              </div>
            </div>);
          })}
        </div>
      </div>
    )}

    {/* This Week */}
    {weekActions.length>0&&(
      <div style={{background:"rgba(251,191,36,0.05)",border:"1px solid rgba(251,191,36,0.15)",borderRadius:"14px",padding:"20px"}}>
        <h3 style={{fontSize:"14px",fontWeight:700,color:"#fcd34d",marginBottom:"16px",display:"flex",alignItems:"center",gap:"8px"}}>
          <span style={{fontSize:"18px"}}>üìÖ</span> √âCH√âANCES CETTE SEMAINE ({weekActions.length})
        </h3>
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(280px,1fr))",gap:"10px"}}>
          {weekActions.map(a=>{
            const d=new Date(a.dateFin);const diff=Math.ceil((d-today)/(1000*60*60*24));const pr=PRIOS[a.priorite];const st=STATUTS[a.statut];
            return(<div key={a.id} style={{background:"rgba(0,0,0,0.2)",border:"1px solid rgba(251,191,36,0.1)",borderRadius:"10px",padding:"12px 14px"}}>
              <div style={{display:"flex",alignItems:"center",gap:"8px",marginBottom:"6px"}}>
                <span style={{fontSize:"10px",fontWeight:700,padding:"3px 8px",borderRadius:"5px",background:diff===0?"rgba(239,68,68,0.15)":diff<=2?"rgba(251,191,36,0.15)":"rgba(96,165,250,0.1)",color:diff===0?"#fca5a5":diff<=2?"#fcd34d":"#93c5fd"}}>
                  {diff===0?"Aujourd'hui":diff===1?"Demain":`Dans ${diff}j`}
                </span>
                <span style={{fontSize:"9px",color:pr.color,fontWeight:600}}>{pr.icon}</span>
                <span style={{fontSize:"9px",fontWeight:600,padding:"2px 6px",borderRadius:"4px",background:st.bg,color:st.color}}>{st.label}</span>
              </div>
              <div style={{fontSize:"12px",fontWeight:600,color:"#e2e8f0",marginBottom:"6px"}}>{a.action}</div>
              <RespChips list={a.responsables}/>
            </div>);
          })}
        </div>
      </div>
    )}

    {/* All good message */}
    {lateActions.length===0&&weekActions.length===0&&(
      <div style={{background:"rgba(16,185,129,0.05)",border:"1px solid rgba(16,185,129,0.15)",borderRadius:"14px",padding:"30px",textAlign:"center"}}>
        <span style={{fontSize:"40px",display:"block",marginBottom:"12px"}}>üéâ</span>
        <h3 style={{fontSize:"16px",fontWeight:600,color:"#6ee7b7",marginBottom:"6px"}}>Tout est sous contr√¥le !</h3>
        <p style={{fontSize:"12px",color:"#64748b"}}>Aucune action en retard, aucune √©ch√©ance urgente cette semaine.</p>
      </div>
    )}

    {/* Workload by person */}
    <div style={{background:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.04)",borderRadius:"14px",padding:"20px"}}>
      <h3 style={{fontSize:"13px",fontWeight:600,color:"#94a3b8",marginBottom:"16px",letterSpacing:"0.5px"}}>üë• CHARGE PAR RESPONSABLE</h3>
      <div style={{display:"flex",flexWrap:"wrap",gap:"10px"}}>
        {(() => {
          const resp={};
          actions.filter(a=>a.statut!=="fait").forEach(a=>{
            (a.responsables||[]).forEach(r=>{resp[r]=(resp[r]||0)+1;});
          });
          const sorted=Object.entries(resp).sort((a,b)=>b[1]-a[1]);
          if(sorted.length===0)return<span style={{fontSize:"12px",color:"#64748b"}}>Aucune action assign√©e en cours</span>;
          return sorted.map(([name,count],i)=>(
            <div key={i} style={{display:"flex",alignItems:"center",gap:"8px",background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:"8px",padding:"8px 12px"}}>
              <span style={{fontSize:"12px",fontWeight:600,color:"#e2e8f0"}}>{name}</span>
              <span style={{fontSize:"11px",fontWeight:700,padding:"2px 8px",borderRadius:"10px",background:count>3?"rgba(239,68,68,0.15)":count>1?"rgba(251,191,36,0.15)":"rgba(16,185,129,0.15)",color:count>3?"#fca5a5":count>1?"#fcd34d":"#6ee7b7"}}>{count}</span>
            </div>
          ));
        })()}
      </div>
    </div>
  </div>);
}

/* Task Form */
function TaskForm({task,onSave,onCancel,onDelete}){
  const safeTask={
    id:task?.id||gid(),
    action:task?.action||"",
    detail:task?.detail||"",
    responsables:Array.isArray(task?.responsables)?[...task.responsables]:[],
    dateDebut:task?.dateDebut||new Date().toISOString().slice(0,10),
    dateFin:task?.dateFin||new Date(Date.now()+7*864e5).toISOString().slice(0,10),
    priorite:task?.priorite||"moyenne",
    statut:task?.statut||"a_faire",
    categorie:task?.categorie||"PM"
  };
  const[form,setForm]=useState(safeTask);
  const[nr,setNr]=useState("");
  const u=(k,v)=>setForm(p=>({...p,[k]:v}));
  const addR=()=>{if(nr.trim()){u("responsables",[...form.responsables,nr.trim()]);setNr("");}};
  const rmR=i=>u("responsables",form.responsables.filter((_,j)=>j!==i));
  return(<div style={{display:"flex",flexDirection:"column",gap:"14px"}}>
    <div><FL>Action</FL><Inp value={form.action} onChange={e=>u("action",e.target.value)} placeholder="Intitul√© de l'action..."/></div>
    <div><FL>D√©tail</FL><textarea value={form.detail||""} onChange={e=>u("detail",e.target.value)} placeholder="Description..." style={{width:"100%",minHeight:"70px",padding:"9px 13px",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:"9px",color:"#e2e8f0",fontSize:"13px",outline:"none",resize:"vertical",fontFamily:"inherit",boxSizing:"border-box"}}/></div>
    <div>
      <FL>Responsables</FL>
      <div style={{display:"flex",flexWrap:"wrap",gap:"5px",marginBottom:"7px"}}>
        {form.responsables.map((r,i)=><span key={i} style={{display:"inline-flex",alignItems:"center",gap:"5px",padding:"4px 10px",background:"rgba(255,255,255,0.08)",borderRadius:"7px",fontSize:"12px",fontWeight:600,color:"#e2e8f0"}}>{r}<span onClick={()=>rmR(i)} style={{cursor:"pointer",opacity:0.5,fontSize:"13px"}}>√ó</span></span>)}
      </div>
      <div style={{display:"flex",gap:"7px"}}><Inp value={nr} onChange={e=>setNr(e.target.value)} placeholder="Ajouter..." style={{flex:1}} onKeyDown={e=>{if(e.key==="Enter"){e.preventDefault();addR();}}}/><Btn onClick={addR} variant="ghost">+</Btn></div>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"10px"}}>
      <div><FL>D√©but</FL><Inp type="date" value={form.dateDebut} onChange={e=>u("dateDebut",e.target.value)}/></div>
      <div><FL>Fin</FL><Inp type="date" value={form.dateFin} onChange={e=>u("dateFin",e.target.value)}/></div>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"10px"}}>
      <div><FL>Priorit√©</FL><Sel value={form.priorite} onChange={e=>u("priorite",e.target.value)}>{Object.entries(PRIOS).map(([k,v])=><option key={k} value={k}>{v.icon} {v.label}</option>)}</Sel></div>
      <div><FL>Statut</FL><Sel value={form.statut} onChange={e=>u("statut",e.target.value)}>{Object.entries(STATUTS).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}</Sel></div>
      <div><FL>Cat√©gorie</FL><Sel value={form.categorie} onChange={e=>u("categorie",e.target.value)}>{CATS.map(c=><option key={c} value={c}>{c}</option>)}</Sel></div>
    </div>
    <div style={{display:"flex",gap:"8px",justifyContent:"flex-end",marginTop:"6px"}}>
      {onDelete&&<Btn variant="danger" onClick={()=>onDelete(form.id)}>üóë Supprimer</Btn>}
      <div style={{flex:1}}/>
      <Btn variant="ghost" onClick={onCancel}>Annuler</Btn>
      <Btn variant="primary" onClick={()=>onSave(form)}>üíæ Enregistrer</Btn>
    </div>
  </div>);
}

/* Timeline */
function TimelineView({actions,onEdit}){
  const allD=actions.flatMap(a=>[new Date(a.dateDebut),new Date(a.dateFin)]);
  if(!allD.length)return<div style={{padding:"40px",textAlign:"center",color:"#475569"}}>Aucune action</div>;
  const mn=new Date(Math.min(...allD));const mx=new Date(Math.max(...allD));
  mn.setDate(mn.getDate()-2);mx.setDate(mx.getDate()+3);
  const td=Math.ceil((mx-mn)/864e5);const dw=46;const rh=50;
  const days=[];for(let i=0;i<=td;i++){const d=new Date(mn);d.setDate(d.getDate()+i);days.push(d);}
  const weeks=[];let cw=null;
  days.forEach(d=>{const wn=gW(d);const k=d.getFullYear()+"-W"+wn;if(!cw||cw.key!==k){cw={key:k,label:"S"+wn,days:1};weeks.push(cw);}else{cw.days++;}});
  function gW(d){const t=new Date(d);t.setHours(0,0,0,0);t.setDate(t.getDate()+3-((t.getDay()+6)%7));const w1=new Date(t.getFullYear(),0,4);return 1+Math.round(((t-w1)/864e5-3+((w1.getDay()+6)%7))/7);}
  const sorted=[...actions].sort((a,b)=>new Date(a.dateDebut)-new Date(b.dateDebut));
  const todayDate=new Date();todayDate.setHours(0,0,0,0);const tOff=Math.ceil((todayDate-mn)/864e5);
  return(<div style={{overflowX:"auto",borderRadius:"12px",border:"1px solid rgba(255,255,255,0.04)",background:"rgba(255,255,255,0.015)"}}>
    <div style={{minWidth:td*dw+300}}>
      <div style={{display:"flex",position:"sticky",top:0,zIndex:10,background:"#10141f"}}>
        <div style={{width:"300px",minWidth:"300px",padding:"8px 14px",borderBottom:"1px solid rgba(255,255,255,0.06)",borderRight:"1px solid rgba(255,255,255,0.04)",display:"flex",alignItems:"flex-end"}}><span style={{fontSize:"10px",fontWeight:600,color:"#525d6e",letterSpacing:"1.5px",textTransform:"uppercase"}}>Action</span></div>
        <div style={{flex:1}}>
          <div style={{display:"flex",borderBottom:"1px solid rgba(255,255,255,0.03)"}}>{weeks.map(w=><div key={w.key} style={{width:w.days*dw,minWidth:w.days*dw,padding:"5px 0",textAlign:"center",fontSize:"10px",fontWeight:600,color:"#818cf8",borderRight:"1px solid rgba(255,255,255,0.03)"}}>{w.label}</div>)}</div>
          <div style={{display:"flex",borderBottom:"1px solid rgba(255,255,255,0.06)"}}>{days.map((d,i)=>{const we=d.getDay()===0||d.getDay()===6;const it=d.toDateString()===todayDate.toDateString();return<div key={i} style={{width:dw,minWidth:dw,padding:"3px 0",textAlign:"center",fontSize:"9px",fontWeight:it?700:400,color:it?"#818cf8":we?"#2a3040":"#475569",background:it?"rgba(129,140,248,0.06)":we?"rgba(0,0,0,0.12)":"transparent",borderRight:"1px solid rgba(255,255,255,0.02)"}}>{d.toLocaleDateString("fr-FR",{day:"numeric",month:"short"}).replace(".","")}</div>;})}</div>
        </div>
      </div>
      {sorted.map((a,i)=>{
        const s=Math.max(0,Math.ceil((new Date(a.dateDebut)-mn)/864e5));const e=Math.ceil((new Date(a.dateFin)-mn)/864e5);
        const w=Math.max(e-s,1)*dw;const l=s*dw;const st=STATUTS[a.statut];const cc=CAT_COLORS[a.categorie]||"#818cf8";const late=isLate(a);
        return(<div key={a.id} style={{display:"flex",borderBottom:"1px solid rgba(255,255,255,0.03)",background:i%2===0?"transparent":"rgba(255,255,255,0.008)"}}>
          <div onClick={()=>onEdit(a)} style={{width:"300px",minWidth:"300px",padding:"8px 14px",borderRight:"1px solid rgba(255,255,255,0.04)",display:"flex",flexDirection:"column",justifyContent:"center",cursor:"pointer",gap:"4px"}} onMouseEnter={e=>e.currentTarget.style.background="rgba(255,255,255,0.02)"} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
            <div style={{display:"flex",alignItems:"center",gap:"6px"}}>
              {late&&<span style={{fontSize:"10px"}}>‚ö†Ô∏è</span>}
              <span style={{fontSize:"9px",fontWeight:600,padding:"2px 7px",borderRadius:"4px",background:`${cc}15`,color:cc}}>{a.categorie}</span>
              <span style={{fontSize:"11px",fontWeight:600,color:late?"#fca5a5":"#e2e8f0",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1}}>{a.action}</span>
            </div>
            <RespChips list={a.responsables}/>
          </div>
          <div style={{flex:1,position:"relative",height:rh}}>
            {days.map((d,di)=>(d.getDay()===0||d.getDay()===6)?<div key={di} style={{position:"absolute",left:di*dw,top:0,width:dw,height:"100%",background:"rgba(0,0,0,0.08)"}}/>:null)}
            {tOff>=0&&tOff<=td&&<div style={{position:"absolute",left:tOff*dw+dw/2-1,top:0,width:"2px",height:"100%",background:"rgba(129,140,248,0.3)",zIndex:2}}/>}
            <div onClick={()=>onEdit(a)} style={{position:"absolute",left:l+3,top:"50%",transform:"translateY(-50%)",width:Math.max(w-6,20),height:"26px",borderRadius:"7px",background:late?`linear-gradient(135deg,rgba(239,68,68,0.25),rgba(239,68,68,0.1))`:`linear-gradient(135deg,${cc}25,${cc}10)`,border:`1px solid ${late?"rgba(239,68,68,0.4)":cc+"40"}`,display:"flex",alignItems:"center",paddingLeft:"8px",gap:"5px",cursor:"pointer",transition:"all 0.2s",zIndex:3,overflow:"hidden"}} onMouseEnter={e=>{e.currentTarget.style.borderColor=late?"#ef4444":cc;}} onMouseLeave={e=>{e.currentTarget.style.borderColor=late?"rgba(239,68,68,0.4)":cc+"40";}}>
              <span style={{width:"5px",height:"5px",borderRadius:"50%",background:st.color,flexShrink:0}}/><span style={{fontSize:"9px",fontWeight:600,color:"#e2e8f0",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{a.action}</span>
            </div>
          </div>
        </div>);
      })}
    </div>
  </div>);
}

/* Import CR */
function ImportCR({open,onClose,onImport,existing}){
  const[raw,setRaw]=useState("");const[parsed,setParsed]=useState([]);const[sel,setSel]=useState({});const[err,setErr]=useState("");const[step,setStep]=useState("paste");
  const reset=()=>{setRaw("");setParsed([]);setSel({});setErr("");setStep("paste");};
  const parse=()=>{setErr("");let t=raw.trim();let j=t;const bm=t.match(/```json_actions\s*([\s\S]*?)```/);if(bm)j=bm[1].trim();else{const am=t.match(/\[\s*\{[\s\S]*\}\s*\]/);if(am)j=am[0];}
    try{const d=JSON.parse(j);if(!Array.isArray(d)||!d.length){setErr("Tableau vide.");return;}
      const v=d.map((it,i)=>{if(!it.action)throw new Error(`#${i+1}: "action" manquant`);return normalizeAction({id:gid(),action:it.action||"",detail:it.detail||"",responsables:Array.isArray(it.responsables)?it.responsables:[],dateDebut:it.dateDebut||new Date().toISOString().slice(0,10),dateFin:it.dateFin||new Date(Date.now()+7*864e5).toISOString().slice(0,10),priorite:["critique","haute","moyenne"].includes(it.priorite)?it.priorite:"moyenne",statut:"a_faire",categorie:CATS.includes(it.categorie)?it.categorie:"PM"});});
      const ex=new Set(existing.map(a=>a.action.toLowerCase().trim()));const s={};v.forEach(a=>{s[a.id]=!ex.has(a.action.toLowerCase().trim());});setParsed(v);setSel(s);setStep("preview");
    }catch(e){setErr("Erreur: "+e.message);}};
  const toggle=id=>setSel(p=>({...p,[id]:!p[id]}));const cnt=parsed.filter(a=>sel[a.id]).length;
  const doImp=()=>{onImport(parsed.filter(a=>sel[a.id]));reset();onClose();};
  if(!open)return null;
  return(<div style={{position:"fixed",inset:0,zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center"}} onClick={()=>{reset();onClose();}}>
    <div style={{position:"absolute",inset:0,background:"rgba(0,0,0,0.6)",backdropFilter:"blur(4px)"}}/>
    <div onClick={e=>e.stopPropagation()} style={{position:"relative",width:"92%",maxWidth:"680px",maxHeight:"90vh",overflow:"auto",background:"#151a28",border:"1px solid rgba(255,255,255,0.07)",borderRadius:"16px",padding:"28px"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"}}><h3 style={{margin:0,fontSize:"17px",fontWeight:600,color:"#e2e8f0"}}>üìã Import CR</h3><button onClick={()=>{reset();onClose();}} style={{background:"rgba(255,255,255,0.06)",border:"none",color:"#94a3b8",width:"30px",height:"30px",borderRadius:"8px",cursor:"pointer",fontSize:"15px"}}>‚úï</button></div>
      {step==="paste"&&<div>
        <p style={{fontSize:"12px",color:"#94a3b8",marginBottom:"12px"}}>Collez le bloc <code style={{background:"rgba(129,140,248,0.12)",padding:"1px 5px",borderRadius:"3px",color:"#a5b4fc",fontSize:"11px"}}>json_actions</code></p>
        <textarea value={raw} onChange={e=>setRaw(e.target.value)} placeholder="Collez le JSON ici..." style={{width:"100%",minHeight:"180px",padding:"12px",background:"rgba(0,0,0,0.2)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:"10px",color:"#e2e8f0",fontSize:"12px",fontFamily:"monospace",outline:"none",resize:"vertical",boxSizing:"border-box"}}/>
        {err&&<div style={{marginTop:"8px",padding:"8px 12px",background:"rgba(239,68,68,0.08)",border:"1px solid rgba(239,68,68,0.2)",borderRadius:"7px",fontSize:"11px",color:"#fca5a5"}}>‚ö†Ô∏è {err}</div>}
        <div style={{display:"flex",gap:"8px",justifyContent:"flex-end",marginTop:"14px"}}><Btn variant="ghost" onClick={()=>{reset();onClose();}}>Annuler</Btn><Btn variant="primary" onClick={parse}>Analyser ‚Üí</Btn></div>
      </div>}
      {step==="preview"&&<div>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}><p style={{fontSize:"12px",color:"#94a3b8",margin:0}}><b style={{color:"#10b981"}}>{parsed.length}</b> d√©tect√©es ¬∑ <b style={{color:"#818cf8"}}>{cnt}</b> s√©lectionn√©es</p><div style={{display:"flex",gap:"6px"}}><button onClick={()=>{const s={};parsed.forEach(a=>{s[a.id]=true;});setSel(s);}} style={{fontSize:"10px",background:"none",border:"none",color:"#818cf8",cursor:"pointer",textDecoration:"underline"}}>Tout</button><button onClick={()=>{const s={};parsed.forEach(a=>{s[a.id]=false;});setSel(s);}} style={{fontSize:"10px",background:"none",border:"none",color:"#64748b",cursor:"pointer",textDecoration:"underline"}}>Aucun</button></div></div>
        <div style={{display:"flex",flexDirection:"column",gap:"5px",maxHeight:"350px",overflow:"auto"}}>{parsed.map(a=>{return(<div key={a.id} onClick={()=>toggle(a.id)} style={{padding:"10px 12px",borderRadius:"8px",cursor:"pointer",background:sel[a.id]?"rgba(129,140,248,0.06)":"rgba(255,255,255,0.015)",border:`1px solid ${sel[a.id]?"rgba(129,140,248,0.2)":"rgba(255,255,255,0.04)"}`,opacity:sel[a.id]?1:0.5}}><div style={{display:"flex",alignItems:"center",gap:"8px"}}><div style={{width:"18px",height:"18px",borderRadius:"5px",border:`2px solid ${sel[a.id]?"#818cf8":"#475569"}`,background:sel[a.id]?"#818cf8":"transparent",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"11px",color:"white",flexShrink:0}}>{sel[a.id]&&"‚úì"}</div><div style={{flex:1}}><div style={{fontSize:"12px",fontWeight:600,color:"#e2e8f0"}}>{a.action}</div></div></div></div>);})}</div>
        <div style={{display:"flex",gap:"8px",justifyContent:"flex-end",marginTop:"14px"}}><Btn variant="ghost" onClick={()=>setStep("paste")}>‚Üê Retour</Btn><Btn variant="primary" onClick={doImp}>üì• Importer {cnt}</Btn></div>
      </div>}
    </div></div>);
}

/* ‚ïê‚ïê MAIN ‚ïê‚ïê */
function App(){
  const[actions,setActions]=useState([]);
  const[loading,setLoading]=useState(true);
  const[online,setOnline]=useState(true);
  const[vue,setVue]=useState("dashboard");
  const[fCat,setFCat]=useState("Tous");const[fStat,setFStat]=useState("tous");
  const[expId,setExpId]=useState(null);
  const[modal,setModal]=useState(false);const[editing,setEditing]=useState(null);
  const[impOpen,setImpOpen]=useState(false);
  const[mt,setMt]=useState(false);const[dragId,setDragId]=useState(null);const[dragCol,setDragCol]=useState(null);

  useEffect(()=>{
    initFirebase((data)=>{setActions(data);setLoading(false);});
    const connRef=firebase.database().ref('.info/connected');
    connRef.on('value',(snap)=>{setOnline(!!snap.val());});
    return()=>{actionsRef.off();connRef.off();};
  },[]);
  useEffect(()=>{setTimeout(()=>setMt(true),50);},[]);

  const upd=useCallback(n=>{setActions(n);saveToFirebase(n);},[]);
  const onSave=t=>{const ex=actions.find(a=>a.id===t.id);upd(ex?actions.map(a=>a.id===t.id?normalizeAction(t):a):[...actions,normalizeAction(t)]);setModal(false);setEditing(null);};
  const onDel=id=>{upd(actions.filter(a=>a.id!==id));setModal(false);setEditing(null);};
  const cycle=id=>{const o=["a_faire","en_cours","fait","bloque"];upd(actions.map(a=>a.id!==id?a:{...a,statut:o[(o.indexOf(a.statut)+1)%4]}));};
  const setStatus=(id,statut)=>upd(actions.map(a=>a.id===id?{...a,statut}:a));
  const edit=t=>{setEditing(normalizeAction(t));setModal(true);};
  const mv=(id,d)=>{const i=actions.findIndex(a=>a.id===id);const t=i+d;if(t<0||t>=actions.length)return;const n=[...actions];[n[i],n[t]]=[n[t],n[i]];upd(n);};
  const drop=col=>{if(dragId)upd(actions.map(a=>a.id===dragId?{...a,statut:col}:a));setDragId(null);setDragCol(null);};
  const expJSON=()=>{const b=new Blob([JSON.stringify(actions,null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download="suivi-actions.json";a.click();};
  const impJSON=()=>{const inp=document.createElement("input");inp.type="file";inp.accept=".json";inp.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(Array.isArray(d))upd(d.map(normalizeAction));}catch(e){alert("Fichier invalide");}};r.readAsText(f);};inp.click();};
  const rst=()=>{if(confirm("Reset ?"))upd(INIT);};

  const filtered=actions.filter(a=>{
    if(fCat!=="Tous"&&a.categorie!==fCat)return false;
    if(fStat!=="tous"&&a.statut!==fStat)return false;
    return true;
  });
  const lateCount=actions.filter(isLate).length;
  const sCols=["a_faire","en_cours","fait","bloque"];

  if(loading)return(<div style={{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"100vh",flexDirection:"column",gap:"16px"}}><div style={{width:"40px",height:"40px",border:"3px solid rgba(129,140,248,0.2)",borderTopColor:"#818cf8",borderRadius:"50%",animation:"spin 1s linear infinite"}}/><p style={{color:"#818cf8",fontSize:"14px"}}>Connexion...</p><style>{`@keyframes spin{to{transform:rotate(360deg)}}`}</style></div>);

  return(<div style={{position:"relative",zIndex:1}}>
    <div style={{position:"fixed",inset:0,pointerEvents:"none",zIndex:0}}>
      <div style={{position:"absolute",top:"-15%",right:"-8%",width:"700px",height:"700px",background:"radial-gradient(circle,rgba(99,102,241,0.04) 0%,transparent 60%)",borderRadius:"50%"}}/>
      <div style={{position:"absolute",bottom:"-8%",left:"-4%",width:"500px",height:"500px",background:"radial-gradient(circle,rgba(56,189,248,0.03) 0%,transparent 60%)",borderRadius:"50%"}}/>
    </div>
    <div style={{position:"relative",zIndex:1,maxWidth:"1400px",margin:"0 auto",padding:"26px 22px"}}>

      {/* Header */}
      <div style={{opacity:mt?1:0,transform:mt?"translateY(0)":"translateY(-14px)",transition:"all 0.6s",marginBottom:"22px",display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:"14px"}}>
        <div>
          <div style={{display:"flex",alignItems:"center",gap:"8px",marginBottom:"5px"}}>
            <div style={{width:"6px",height:"6px",borderRadius:"50%",background:"#818cf8"}}/>
            <span style={{fontSize:"10px",fontWeight:500,letterSpacing:"2.5px",textTransform:"uppercase",color:"#818cf8"}}>SUIVI D'ACTIONS</span>
            <SyncStatus online={online}/>
            {lateCount>0&&<span style={{fontSize:"10px",fontWeight:600,padding:"2px 8px",borderRadius:"10px",background:"rgba(239,68,68,0.15)",color:"#fca5a5"}}>‚ö†Ô∏è {lateCount} en retard</span>}
          </div>
          <h1 style={{fontFamily:"'Fraunces',serif",fontSize:"clamp(24px,3.2vw,34px)",fontWeight:600,margin:"3px 0",lineHeight:1.15,color:"#f1f5f9"}}>POC EAM ‚Äî SAP</h1>
          <p style={{color:"#475569",fontSize:"11px"}}>{new Date().toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}</p>
        </div>
        <div style={{display:"flex",gap:"6px",flexWrap:"wrap",alignItems:"center"}}>
          <Btn onClick={()=>setImpOpen(true)} style={{fontSize:"11px",padding:"7px 13px",background:"rgba(16,185,129,0.12)",border:"1px solid rgba(16,185,129,0.3)",color:"#6ee7b7"}}>üìã Import CR</Btn>
          <Btn onClick={expJSON} variant="ghost" style={{fontSize:"10px",padding:"7px 12px"}}>‚¨á Export</Btn>
          <Btn onClick={impJSON} variant="ghost" style={{fontSize:"10px",padding:"7px 12px"}}>‚¨Ü Import</Btn>
          <Btn onClick={rst} variant="ghost" style={{fontSize:"10px",padding:"7px 12px"}}>‚Ü∫</Btn>
          <Btn onClick={()=>{setEditing(null);setModal(true);}} variant="primary" style={{padding:"9px 20px",fontSize:"13px"}}>Ôºã Action</Btn>
        </div>
      </div>

      {/* Navigation */}
      <div style={{display:"flex",flexWrap:"wrap",gap:"12px",marginBottom:"20px"}}>
        <div className="filter-group">
          <span className="filter-label">Vue</span>
          <div style={{display:"flex",gap:"4px"}}>
            {[{k:"dashboard",l:"üìä Dashboard"},{k:"liste",l:"‚ò∞ Liste"},{k:"kanban",l:"‚ñ¶ Kanban"},{k:"timeline",l:"‚ó´ Timeline"}].map(v=>
              <button key={v.k} onClick={()=>setVue(v.k)} style={{padding:"6px 12px",fontSize:"11px",fontWeight:600,border:"none",cursor:"pointer",borderRadius:"6px",background:vue===v.k?"rgba(129,140,248,0.2)":"transparent",color:vue===v.k?"#c7d2fe":"#525d6e",transition:"all 0.15s"}}>{v.l}</button>
            )}
          </div>
        </div>
        {vue!=="dashboard"&&(<>
          <div className="filter-group">
            <span className="filter-label" style={{color:"#60a5fa"}}>Statut</span>
            <div style={{display:"flex",gap:"4px",flexWrap:"wrap"}}>
              <button onClick={()=>setFStat("tous")} style={{padding:"5px 10px",fontSize:"10px",fontWeight:500,border:"none",cursor:"pointer",borderRadius:"5px",background:fStat==="tous"?"rgba(96,165,250,0.2)":"transparent",color:fStat==="tous"?"#93c5fd":"#525d6e"}}>Tous</button>
              {Object.entries(STATUTS).map(([k,v])=><button key={k} onClick={()=>setFStat(k)} style={{padding:"5px 10px",fontSize:"10px",fontWeight:500,border:"none",cursor:"pointer",borderRadius:"5px",background:fStat===k?v.bg:"transparent",color:fStat===k?v.color:"#525d6e"}}>{v.label}</button>)}
            </div>
          </div>
          <div className="filter-group">
            <span className="filter-label" style={{color:"#fbbf24"}}>Cat√©gorie</span>
            <div style={{display:"flex",gap:"4px",flexWrap:"wrap"}}>
              <button onClick={()=>setFCat("Tous")} style={{padding:"5px 10px",fontSize:"10px",fontWeight:500,border:"none",cursor:"pointer",borderRadius:"5px",background:fCat==="Tous"?"rgba(251,191,36,0.15)":"transparent",color:fCat==="Tous"?"#fcd34d":"#525d6e"}}>Toutes</button>
              {CATS.map(c=><button key={c} onClick={()=>setFCat(c)} style={{padding:"5px 10px",fontSize:"10px",fontWeight:500,border:"none",cursor:"pointer",borderRadius:"5px",background:fCat===c?"rgba(251,191,36,0.15)":"transparent",color:fCat===c?"#fcd34d":"#525d6e"}}>{c}</button>)}
            </div>
          </div>
        </>)}
      </div>

      {/* DASHBOARD */}
      {vue==="dashboard"&&<DashboardView actions={actions} onEdit={edit} onStatusChange={setStatus}/>}

      {/* LIST */}
      {vue==="liste"&&<div style={{display:"flex",flexDirection:"column",gap:"5px"}}>
        {filtered.map((a,i)=>{const isX=expId===a.id;const st=STATUTS[a.statut];const pr=PRIOS[a.priorite];const late=isLate(a);
          return(<div key={a.id} style={{background:late?"rgba(239,68,68,0.03)":"rgba(255,255,255,0.02)",border:`1px solid ${late?"rgba(239,68,68,0.15)":isX?"rgba(129,140,248,0.15)":"rgba(255,255,255,0.04)"}`,borderRadius:"10px",overflow:"hidden",transition:"all 0.2s"}}>
            <div style={{display:"flex",alignItems:"stretch"}}>
              <div style={{width:"4px",background:late?"#ef4444":st.color,flexShrink:0}}/>
              <div style={{flex:1,padding:"11px 14px",cursor:"pointer",display:"flex",flexDirection:"column",gap:"6px"}} onClick={()=>setExpId(isX?null:a.id)}>
                <div style={{display:"flex",alignItems:"center",gap:"6px",flexWrap:"wrap"}}>
                  {late&&<span style={{fontSize:"9px",fontWeight:600,padding:"2px 6px",borderRadius:"4px",background:"rgba(239,68,68,0.15)",color:"#fca5a5"}}>‚ö†Ô∏è -{daysLate(a)}j</span>}
                  <span style={{fontSize:"9px",fontWeight:600,color:pr.color}}>{pr.icon} {pr.label}</span>
                  <span style={{fontSize:"9px",fontWeight:600,padding:"2px 7px",borderRadius:"4px",background:"rgba(129,140,248,0.06)",color:"#a5b4fc"}}>{a.categorie}</span>
                </div>
                <div style={{fontSize:"13px",fontWeight:600,color:late?"#fca5a5":"#e2e8f0",lineHeight:1.3}}>{a.action}</div>
                <div style={{display:"flex",alignItems:"center",gap:"12px",flexWrap:"wrap"}}>
                  <RespChips list={a.responsables}/>
                  <span style={{fontSize:"10px",color:"#475569"}}>üìÖ {new Date(a.dateDebut).toLocaleDateString("fr-FR")} ‚Üí {new Date(a.dateFin).toLocaleDateString("fr-FR")}</span>
                </div>
              </div>
              <div style={{display:"flex",alignItems:"center",gap:"5px",padding:"10px 12px"}}>
                <div style={{display:"flex",flexDirection:"column",gap:"1px"}}>
                  <button onClick={()=>mv(a.id,-1)} style={{background:"none",border:"none",cursor:"pointer",fontSize:"9px",color:"#475569",padding:"1px 5px"}}>‚ñ≤</button>
                  <button onClick={()=>mv(a.id,1)} style={{background:"none",border:"none",cursor:"pointer",fontSize:"9px",color:"#475569",padding:"1px 5px"}}>‚ñº</button>
                </div>
                <button onClick={e=>{e.stopPropagation();cycle(a.id);}} style={{padding:"6px 12px",borderRadius:"7px",border:`1px solid ${st.color}35`,background:st.bg,color:st.color,fontSize:"10px",fontWeight:600,cursor:"pointer"}}>{st.label}</button>
                <button onClick={e=>{e.stopPropagation();edit(a);}} style={{padding:"6px 8px",borderRadius:"7px",border:"1px solid rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.03)",color:"#94a3b8",fontSize:"11px",cursor:"pointer"}}>‚úé</button>
              </div>
            </div>
            {isX&&<div style={{padding:"0 14px 12px 18px",borderTop:"1px solid rgba(255,255,255,0.04)"}}>
              <div style={{padding:"10px 12px",marginTop:"8px",background:"rgba(129,140,248,0.025)",borderRadius:"7px",border:"1px solid rgba(129,140,248,0.05)"}}>
                <div style={{fontSize:"9px",fontWeight:600,letterSpacing:"1.5px",textTransform:"uppercase",color:"#818cf8",marginBottom:"3px"}}>D√âTAIL</div>
                <p style={{fontSize:"12px",color:"#94a3b8",lineHeight:1.5,margin:0}}>{a.detail||"Aucun d√©tail."}</p>
              </div>
            </div>}
          </div>);
        })}
        {!filtered.length&&<div style={{padding:"36px",textAlign:"center",color:"#475569",fontSize:"13px"}}>Aucune action.</div>}
      </div>}

      {/* KANBAN */}
      {vue==="kanban"&&<div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(260px,1fr))",gap:"12px"}}>
        {sCols.map(col=>{const st=STATUTS[col];const items=filtered.filter(a=>a.statut===col);const isOv=dragCol===col;
          return(<div key={col} onDragOver={e=>{e.preventDefault();setDragCol(col);}} onDragLeave={()=>setDragCol(null)} onDrop={()=>drop(col)}
            style={{background:isOv?"rgba(129,140,248,0.04)":"rgba(255,255,255,0.012)",borderRadius:"12px",border:`1px solid ${isOv?"rgba(129,140,248,0.15)":"rgba(255,255,255,0.04)"}`,overflow:"hidden"}}>
            <div style={{padding:"12px 14px",borderBottom:"1px solid rgba(255,255,255,0.04)",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div style={{display:"flex",alignItems:"center",gap:"8px"}}><div style={{width:"8px",height:"8px",borderRadius:"50%",background:st.color}}/><span style={{fontSize:"12px",fontWeight:600,color:st.color}}>{st.label}</span></div>
              <span style={{fontSize:"10px",fontWeight:700,padding:"3px 8px",borderRadius:"5px",background:st.bg,color:st.color}}>{items.length}</span>
            </div>
            <div style={{padding:"8px",display:"flex",flexDirection:"column",gap:"6px",minHeight:"100px"}}>
              {items.map(a=>{const pr=PRIOS[a.priorite];const late=isLate(a);
                return(<div key={a.id} draggable onDragStart={()=>setDragId(a.id)} onDragEnd={()=>{setDragId(null);setDragCol(null);}}
                  style={{padding:"12px",borderRadius:"10px",background:late?"rgba(239,68,68,0.05)":dragId===a.id?"rgba(129,140,248,0.06)":"rgba(255,255,255,0.02)",border:`1px solid ${late?"rgba(239,68,68,0.15)":dragId===a.id?"rgba(129,140,248,0.15)":"rgba(255,255,255,0.04)"}`,cursor:"grab",borderLeft:`3px solid ${late?"#ef4444":st.color}`,opacity:dragId===a.id?0.4:1}}>
                  {late&&<div style={{fontSize:"9px",fontWeight:600,padding:"2px 6px",borderRadius:"4px",background:"rgba(239,68,68,0.15)",color:"#fca5a5",marginBottom:"6px",display:"inline-block"}}>‚ö†Ô∏è -{daysLate(a)}j</div>}
                  <div style={{fontSize:"12px",fontWeight:600,color:late?"#fca5a5":"#e2e8f0",marginBottom:"8px",lineHeight:1.35}}>{a.action}</div>
                  <div style={{display:"flex",flexWrap:"wrap",gap:"5px",marginBottom:"8px"}}>
                    <span style={{fontSize:"9px",fontWeight:600,padding:"2px 7px",borderRadius:"4px",background:"rgba(129,140,248,0.06)",color:"#a5b4fc"}}>{a.categorie}</span>
                    <span style={{fontSize:"9px",color:pr.color,fontWeight:600}}>{pr.icon}</span>
                  </div>
                  <RespChips list={a.responsables}/>
                  <div style={{fontSize:"9px",color:"#475569",marginTop:"6px"}}>üìÖ {new Date(a.dateFin).toLocaleDateString("fr-FR")}</div>
                  <button onClick={()=>edit(a)} style={{marginTop:"8px",padding:"4px 10px",fontSize:"9px",fontWeight:600,background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:"5px",color:"#94a3b8",cursor:"pointer"}}>‚úé Modifier</button>
                </div>);
              })}
              {!items.length&&<div style={{padding:"20px",textAlign:"center",color:"#2a3040",fontSize:"11px",border:"1px dashed rgba(255,255,255,0.05)",borderRadius:"8px"}}>Aucune action</div>}
            </div>
          </div>);
        })}
      </div>}

      {vue==="timeline"&&<TimelineView actions={filtered} onEdit={edit}/>}
    </div>

    <ImportCR open={impOpen} onClose={()=>setImpOpen(false)} onImport={n=>upd([...actions,...n])} existing={actions}/>
    <Modal open={modal} onClose={()=>{setModal(false);setEditing(null);}} title={editing?"Modifier":"Nouvelle action"}>
      <TaskForm task={editing} onSave={onSave} onCancel={()=>{setModal(false);setEditing(null);}} onDelete={editing?onDel:null}/>
    </Modal>
  </div>);
}

ReactDOM.render(<App/>,document.getElementById("root"));
</script>
</body>
</html>
